#!/usr/bin/env bash

export PATH="/usr/local/sbin:/usr/local/bin:/sbin:/bin:/usr/sbin:/usr/bin:/usr/games"
CONF_FILE="/etc/ap-or-client.conf"
SCRIPT_NAME="ap-or-client"

# write to syslog
function log()
{
	logger -s -t "[${SCRIPT_NAME}]" "${1}"
}

CURRENT_MODE=$(awk -F '=' '/CURRENT_MODE/ {print $2}' ${CONF_FILE})
log "CURRENT_MODE: ${CURRENT_MODE}"

awk -F '=' '/ssid/ {print $2}' /etc/wpa_supplicant/wpa_supplicant.conf | sed "s/'//g" | sed 's/"//g' > /tmp/ssid-list
SSID_TOTAL=$(cat /tmp/ssid-list | wc -l)

log "Scanning for known APs."
while read SSID; do
	log "Scanning for SSID '${SSID}'."
	iwlist wlan0 scan | grep -q "${SSID}"
	SCAN_RESULT="${?}"
	SSID_TOTAL=$((SSID_TOTAL-SCAN_RESULT))
	#echo "[${SSID}] SCAN_RESULT: ${SCAN_RESULT} | SSID_TOTAL: ${SSID_TOTAL}"
done < /tmp/ssid-list
rm -f /tmp/ssid-list

if [[ "${SSID_TOTAL}" != "0" ]]; then
	# Connectable AP found
	log "Connectable AP found."
	if [[ "${CURRENT_MODE}" != "CLIENT" ]]; then
		log "Changing to CLIENT mode."

		echo "CURRENT_MODE=CLIENT" > ${CONF_FILE}

		rm -f  /etc/network/interfaces 
		ln -fs /etc/network/interfaces-client /etc/network/interfaces

		systemctl stop hostapd
		sleep 1
		systemctl stop dnsmasq
		sleep 1

		ifdown wlan0; ifup wlan0
	else
		log "Staying in CLIENT mode."
	fi
else
	log "No connectable APs found."
	if [[ "${CURRENT_MODE}" != "AP" ]]; then
		log "Changing to AP mode."

		echo "CURRENT_MODE=AP" > ${CONF_FILE}

		rm -f  /etc/network/interfaces 
		ln -fs /etc/network/interfaces-ap /etc/network/interfaces

		ifdown wlan0; ifup wlan0

		systemctl start hostapd
		sleep 1
		systemctl start dnsmasq
	else
		log "Staying in AP mode."
	fi
fi
